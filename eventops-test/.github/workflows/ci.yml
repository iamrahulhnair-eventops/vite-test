name: CI Pipeline

# 1. Source Stage: Define the triggers for the 'main' branch only
on:
  push:
    branches:
      - main  # Trigger on every push to the main branch
  pull_request:
    branches:
      - main  # Trigger when a Pull Request targets the main branch
      
# Define the jobs to run
jobs:
  build_test_and_coverage:
    name: Build, Test, and Coverage Check
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout Code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Setup Node.js Environment
      - name: Setup Node.js v24.7.0
        uses: actions/setup-node@v4
        with:
          node-version: '24.7.0'
          cache: 'npm'

      # 3. Install Dependencies
      - name: Install Dependencies
        run: npm ci

      # 4. Run Tests and Generate LCOV Coverage
      - name: Run Tests and Generate LCOV Coverage
        # This executes your Vitest coverage command
        run: npm run coverage
        
      # 5. Code Quality Integration: Upload Codacy Coverage
      - name: Upload coverage to Codacy
        uses: codacy/codacy-coverage-reporter-action@v1
        with:
          # Remember to set this secret in your GitHub Repository Settings
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: './coverage/lcov.info'